name: Deploy InterviewAce to EC2 (Webhook Method)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install frontend dependencies
      run: npm install
      
    - name: Install backend dependencies
      run: |
        cd server
        npm install
      
    - name: Build frontend
      run: npm run build
      
    - name: Deploy via Webhook
      continue-on-error: false
      run: |
        echo "üöÄ Triggering deployment via webhook..."
        echo "Backend URL: http://54.159.42.7:5000"
        
        # Trigger deployment webhook
        response=$(curl -X POST http://54.159.42.7:5000/api/webhooks/deploy \
          -H "Content-Type: application/json" \
          -H "X-Deployment-Token: ${{ secrets.DEPLOYMENT_TOKEN }}" \
          -d '{"token": "${{ secrets.DEPLOYMENT_TOKEN }}"}' \
          -w "\nHTTP_STATUS:%{http_code}" \
          -s)
        
        http_code=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_STATUS/d')
        
        echo "Response status: $http_code"
        echo "Response body: $body"
        
        if [ "$http_code" != "200" ]; then
          echo "‚ùå Deployment webhook failed with status $http_code"
          echo "$body"
          exit 1
        fi
        
        echo "‚úÖ Deployment webhook triggered successfully"
      
    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        sleep 10
        
        # Check backend health
        for i in {1..10}; do
          if curl -f http://54.159.42.7:5000/api/health > /dev/null 2>&1; then
            echo "‚úÖ Backend is healthy!"
            curl http://54.159.42.7:5000/api/health
            break
          else
            echo "‚è≥ Waiting for backend... (attempt $i/10)"
            sleep 3
          fi
        done
        
        # Check frontend
        if curl -f http://54.159.42.7 > /dev/null 2>&1; then
          echo "‚úÖ Frontend is accessible!"
        else
          echo "‚ö†Ô∏è  Frontend might need a moment to update"
        fi

